<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Let's Do It! – To-Do with Login</title>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css"/>
  <style>
    :root{
      --primary:#5c6bc0;--primary-dark:#3f51b5;
      --danger:#e74c3c;--danger-dark:#c0392b;
      --bg:#f4f6f9;--card:#fff;--text:#333;
      --gray:#bbb;--light:#eee;
    }
    [data-theme="dark"]{
      --bg:#121212;--card:#1e1e1e;--text:#e0e0e0;
      --gray:#777;--light:#333;
    }
    *{margin:0;padding:0;box-sizing:border-box;font-family:'Segoe UI',sans-serif}
    body{background:linear-gradient(135deg,var(--primary),#a777e4);min-height:100vh;color:var(--text);padding:2rem;transition:background .3s}
    .container{max-width:620px;margin:auto;background:var(--card);border-radius:16px;box-shadow:0 12px 36px rgba(0,0,0,.15);overflow:hidden;position:relative}
    header{background:var(--primary);color:#fff;padding:1.5rem;text-align:center;position:relative;display:flex;justify-content:space-between;align-items:center}
    header h1{font-size:1.9rem;font-weight:600}
    .user-area{right:1rem;display:flex;gap:10px;align-items:center;font-size:0.9rem}
    .logout-btn{background:transparent;color:#fff;border:none;font-size:1rem;cursor:pointer}
    .theme-toggle{cursor:pointer;font-size:1.2rem}
    .input-area{padding:1.5rem;display:flex;gap:10px;border-bottom:1px solid var(--light)}
    #taskInput{flex:1;padding:12px;font-size:1rem;border:2px solid var(--light);border-radius:8px;outline:none;transition:border .2s}
    #taskInput:focus{border-color:var(--primary)}
    #dueDate{padding:12px;border:2px solid var(--light);border-radius:8px;font-size:1rem}
    #addBtn{padding:12px 22px;background:var(--primary);color:#fff;border:none;border-radius:8px;font-size:1rem;cursor:pointer;transition:.2s}
    #addBtn:hover{background:var(--primary-dark)}
    .stats{padding:0 1.5rem .5rem;color:var(--gray);font-size:.9rem}
    .tasks{padding:0 1rem 1rem;max-height:420px;overflow-y:auto}
    .task-item{display:flex;align-items:center;padding:12px;background:var(--bg);border-radius:8px;margin-bottom:10px;transition:.2s;position:relative}
    .task-item:hover{background:var(--light)}
    .task-item input[type="checkbox"]{margin-right:12px;transform:scale(1.3);cursor:pointer}
    .task-text{flex:1;font-size:1rem;cursor:text}
    .task-text.completed{text-decoration:line-through;color:var(--gray)}
    .task-text.editing{background:var(--light);padding:4px 8px;border-radius:4px}
    .due{display:inline-block;margin-left:8px;font-size:.85rem;color:var(--primary)}
    .delete-btn{background:var(--danger);color:#fff;border:none;padding:6px 10px;border-radius:6px;cursor:pointer;transition:.2s}
    .delete-btn:hover{background:var(--danger-dark)}
    .empty-state{text-align:center;padding:2.5rem;color:var(--gray);font-style:italic}
    .empty-state i{font-size:3rem;margin-bottom:.5rem;display:block}
    footer{text-align:center;padding:1rem;color:var(--gray);font-size:.9rem}

    /* Auth Modal */
    .modal{display:none;position:fixed;top:0;left:0;width:100%;height:100%;background:rgba(0,0,0,0.6);justify-content:center;align-items:center;z-index:1000}
    .modal.active{display:flex}
    .modal-content{background:var(--card);padding:2rem;border-radius:12px;width:90%;max-width:400px;box-shadow:0 10px 30px rgba(0,0,0,0.2);text-align:center}
    .modal h2{margin-bottom:1rem}
    .modal input{margin:10px 0;width:100%;padding:12px;border:2px solid var(--light);border-radius:8px;font-size:1rem}
    .modal button{width:100%;padding:12px;margin:8px 0;border:none;border-radius:8px;font-size:1rem;cursor:pointer}
    .btn-google{background:#4285f4;color:white}
    .btn-google:hover{background:#3367d6}
    .btn-primary{background:var(--primary);color:white}
    .btn-primary:hover{background:var(--primary-dark)}
    .switch-mode{color:var(--primary);cursor:pointer;text-decoration:underline;font-size:0.9rem}
    .spinner{margin:1.5rem auto;width:32px;height:32px;border:4px solid var(--light);border-top-color:var(--primary);border-radius:50%;animation:spin 1s linear infinite}
    @keyframes spin{to{transform:rotate(360deg)}}
    @media (max-width:480px){.input-area{flex-wrap:wrap}#dueDate{width:100%;margin-top:8px}}
  </style>
</head>
<body>

  <!-- Auth Modal -->
  <div class="modal" id="authModal">
    <div class="modal-content">
      <h2 id="modalTitle">Log In</h2>
      <div id="authForm">
        <input type="email" id="email" placeholder="Email" required />
        <input type="password" id="password" placeholder="Password" required />
        <button class="btn-primary" id="authBtn">Log In</button>
        <button class="btn-google" id="googleBtn">
          <i class="fab fa-google"></i> Continue with Google
        </button>
        <p><span class="switch-mode" id="switchMode">Create an account</span></p>
      </div>
      <div id="authLoading" style="display:none">
        <div class="spinner"></div>
      </div>
    </div>
  </div>

  <!-- Main App (hidden until login) -->
  <div class="container" id="app" style="display:none">
    <header>
      <h1>Let's Do It!</h1>
      <div class="user-area">
        <span id="userEmail"></span>
        <button class="logout-btn" id="logoutBtn" title="Logout"><i class="fas fa-sign-out-alt"></i></button>
        <i class="theme-toggle fas fa-moon" title="Toggle dark mode"></i>
      </div>
    </header>

    <div class="input-area">
      <input type="text" id="taskInput" placeholder="What needs to be done?" />
      <input type="date" id="dueDate" />
      <button id="addBtn">Add</button>
    </div>

    <div class="stats" id="stats"></div>

    <div class="tasks" id="taskList">
      <div class="empty-state"><i class="fas fa-clipboard-list"></i><br>No tasks yet – add one!</div>
    </div>

    <footer>Made with ❤️ by You</footer>
  </div>

  <script type="module">
    // ---------- Firebase ----------
    import { initializeApp } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js';
    import { 
      getFirestore, collection, addDoc, onSnapshot, deleteDoc, doc, updateDoc, 
      serverTimestamp, query, orderBy 
    } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js';
    import { 
      getAuth, signInWithEmailAndPassword, createUserWithEmailAndPassword,
      signInWithPopup, GoogleAuthProvider, onAuthStateChanged, signOut 
    } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js';

    const firebaseConfig = {
      apiKey: "AIzaSyC1Qvlz8HCpeIydqg-etneUt95JkefGoUk",
      authDomain: "lets-do-it-dd683.firebaseapp.com",
      projectId: "lets-do-it-dd683",
      storageBucket: "lets-do-it-dd683.appspot.com",
      messagingSenderId: "994172286869",
      appId: "1:994172286869:web:6eff7b8868fb99062a689c",
      measurementId: "G-8MGGFX5H8K"
    };

    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);
    const auth = getAuth(app);
    const googleProvider = new GoogleAuthProvider();

    // ---------- DOM ----------
    const modal = document.getElementById('authModal');
    const appContainer = document.getElementById('app');
    const modalTitle = document.getElementById('modalTitle');
    const authBtn = document.getElementById('authBtn');
    const googleBtn = document.getElementById('googleBtn');
    const switchMode = document.getElementById('switchMode');
    const emailInput = document.getElementById('email');
    const passwordInput = document.getElementById('password');
    const authForm = document.getElementById('authForm');
    const authLoading = document.getElementById('authLoading');

    const taskInput = document.getElementById('taskInput');
    const dueInput = document.getElementById('dueDate');
    const addBtn = document.getElementById('addBtn');
    const taskList = document.getElementById('taskList');
    const statsEl = document.getElementById('stats');
    const userEmailEl = document.getElementById('userEmail');
    const logoutBtn = document.getElementById('logoutBtn');
    const themeBtn = document.querySelector('.theme-toggle');

    // ---------- Auth State ----------
    let currentUser = null;
    let tasksCol = null;
    let unsubscribeTasks = null;

    onAuthStateChanged(auth, user => {
      currentUser = user;
      if (user) {
        // Logged in
        modal.classList.remove('active');
        appContainer.style.display = 'block';
        userEmailEl.textContent = user.email;
        tasksCol = collection(db, 'users', user.uid, 'tasks');
        startTaskListener();
      } else {
        // Logged out
        appContainer.style.display = 'none';
        modal.classList.add('active');
        if (unsubscribeTasks) unsubscribeTasks();
      }
    });

    // ---------- Auth Functions ----------
    let isLogin = true;

    switchMode.onclick = () => {
      isLogin = !isLogin;
      modalTitle.textContent = isLogin ? 'Log In' : 'Sign Up';
      authBtn.textContent = isLogin ? 'Log In' : 'Create Account';
      switchMode.textContent = isLogin ? 'Create an account' : 'Already have an account? Log in';
    };

    authBtn.onclick = async () => {
      const email = emailInput.value.trim();
      const password = passwordInput.value;
      if (!email || !password) return alert('Fill in all fields');

      authForm.style.display = 'none';
      authLoading.style.display = 'block';

      try {
        if (isLogin) {
          await signInWithEmailAndPassword(auth, email, password);
        } else {
          await createUserWithEmailAndPassword(auth, email, password);
        }
      } catch (err) {
        alert(err.message);
        authForm.style.display = 'block';
        authLoading.style.display = 'none';
      }
    };

    googleBtn.onclick = async () => {
      authForm.style.display = 'none';
      authLoading.style.display = 'block';
      try {
        await signInWithPopup(auth, googleProvider);
      } catch (err) {
        alert(err.message);
        authForm.style.display = 'block';
        authLoading.style.display = 'none';
      }
    };

    logoutBtn.onclick = async () => {
      await signOut(auth);
    };

    // ---------- Task CRUD (per user) ----------
    const formatDate = d => d ? new Date(d).toLocaleDateString(undefined, {month:'short',day:'numeric'}) : '';

    const startTaskListener = () => {
      const q = query(tasksCol, orderBy('due', 'asc'), orderBy('timestamp', 'desc'));
      unsubscribeTasks = onSnapshot(q, snap => {
        const docs = snap.docs.map(d => ({ id: d.id, ...d.data() }));
        renderTasks(docs);
      });
    };

    const renderTasks = (docs) => {
      const sorted = docs.sort((a,b) => {
        const da = a.due?.seconds || 0;
        const db = b.due?.seconds || 0;
        return da - db;
      });

      taskList.innerHTML = sorted.length === 0
        ? `<div class="empty-state"><i class="fas fa-clipboard-list"></i><br>No tasks yet – add one!</div>`
        : '';

      let active = 0, total = sorted.length;
      sorted.forEach(t => {
        if (!t.completed) active++;
        const div = document.createElement('div');
        div.className = 'task-item';
        div.dataset.id = t.id;

        const dueHTML = t.due ? `<span class="due">${formatDate(t.due.toDate())}</span>` : '';
        div.innerHTML = `
          <input type="checkbox" ${t.completed?'checked':''}>
          <span class="task-text ${t.completed?'completed':''}">${t.text}</span>
          ${dueHTML}
          <button class="delete-btn"><i class="fas fa-trash"></i></button>
        `;

        const chk = div.querySelector('input[type="checkbox"]');
        chk.onchange = () => updateDoc(doc(db, 'users', currentUser.uid, 'tasks', t.id), { completed: !t.completed });

        const txt = div.querySelector('.task-text');
        txt.addEventListener('click', () => startEdit(txt, t.id, t.text, t.due));

        const del = div.querySelector('.delete-btn');
        del.onclick = () => deleteDoc(doc(db, 'users', currentUser.uid, 'tasks', t.id));

        // Swipe to delete
        let startX = 0;
        div.addEventListener('touchstart', e => startX = e.touches[0].clientX);
        div.addEventListener('touchend', e => {
          const diff = startX - e.changedTouches[0].clientX;
          if (diff > 80) deleteDoc(doc(db, 'users', currentUser.uid, 'tasks', t.id));
        });

        taskList.appendChild(div);
      });

      statsEl.textContent = `${active} active / ${total} total`;
    };

    const addTask = async () => {
      const text = taskInput.value.trim();
      const due = dueInput.value ? new Date(dueInput.value) : null;
      if (!text) return;

      await addDoc(tasksCol, {
        text,
        completed: false,
        due: due ? serverTimestamp() : null,
        timestamp: serverTimestamp()
      });

      taskInput.value = '';
      dueInput.value = '';
    };

    // Inline edit
    let editing = null;
    const startEdit = (span, id, currentText, currentDue) => {
      if (editing) return;
      editing = span;
      const input = document.createElement('input');
      input.type = 'text';
      input.value = currentText;
      input.className = 'task-text editing';
      span.replaceWith(input);
      input.focus();
      input.select();

      const finish = async () => {
        const newText = input.value.trim() || currentText;
        const newDue = dueInput.value ? new Date(dueInput.value) : (currentDue ? currentDue.toDate() : null);
        await updateDoc(doc(db, 'users', currentUser.uid, 'tasks', id), {
          text: newText,
          due: newDue ? serverTimestamp() : null
        });
        editing = null;
      };

      input.addEventListener('blur', finish);
      input.addEventListener('keydown', e => e.key === 'Enter' && finish());
    };

    // ---------- Init ----------
    addBtn.onclick = addTask;
    taskInput.addEventListener('keydown', e => e.key === 'Enter' && addTask());

    // Dark mode
    const setTheme = (theme) => {
      document.documentElement.dataset.theme = theme;
      localStorage.setItem('theme', theme);
      themeBtn.className = theme === 'dark' ? 'theme-toggle fas fa-sun' : 'theme-toggle fas fa-moon';
    };
    const saved = localStorage.getItem('theme') || (window.matchMedia('(prefers-color-scheme: dark)').matches ? 'dark' : 'light');
    setTheme(saved);
    themeBtn.addEventListener('click', () => setTheme(document.documentElement.dataset.theme === 'dark' ? 'light' : 'dark'));
  </script>
</body>
</html>